<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADVANCED SPEAKING LABS - Complete</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quote-banner {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-left: 5px solid #f59e0b;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
            font-style: italic;
            border: 1px solid #334155;
        }

        .quote-author {
            margin-top: 10px;
            color: #f59e0b;
            font-weight: bold;
        }

        .card {
            background: #1e293b;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }

        h1, h2, h3 {
            margin-bottom: 20px;
            color: #f1f5f9;
        }

        h1 {
            text-align: center;
            color: #3b82f6;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #2563eb;
        }

        button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        button.secondary {
            background: #475569;
            border-color: #334155;
        }

        button.success {
            background: #22c55e;
            border-color: #16a34a;
        }

        button.warning {
            background: #f59e0b;
            border-color: #d97706;
        }

        button.voice {
            background: #8b5cf6;
            border-color: #7c3aed;
        }

        button.danger {
            background: #ef4444;
            border-color: #dc2626;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn-group button {
            flex: 1;
            min-width: 120px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #0f172a;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            color: #3b82f6;
            margin-bottom: 5px;
        }

        .flashcard-container {
            perspective: 2000px;
            margin: 30px 0;
            cursor: pointer;
        }

        .flashcard {
            position: relative;
            width: 100%;
            min-height: 300px;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            min-height: 300px;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            border-radius: 32px;
            background: linear-gradient(145deg, #2d3748, #1e293b);
            border: 2px solid #3b82f6;
        }

        .flashcard-back {
            transform: rotateY(180deg);
            border-color: #22c55e;
        }

        .flashcard-word {
            font-size: 56px;
            font-weight: 800;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .flashcard-meaning {
            font-size: 48px;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 20px;
        }

        .flashcard-example {
            font-size: 18px;
            color: #94a3b8;
            font-style: italic;
            max-width: 80%;
        }

        .results-card {
            background: #0f172a;
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #3b82f6;
        }

        .results-score {
            font-size: 48px;
            font-weight: bold;
            color: #22c55e;
            margin: 15px 0;
        }

        .dictation-area {
            background: #0f172a;
            border-radius: 32px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #334155;
            min-height: 400px;
        }

        .dictation-center {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .big-voice-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .dictation-input {
            font-size: 24px;
            text-align: center;
            background: transparent;
            border: none;
            border-bottom: 3px solid #3b82f6;
            width: 80%;
            margin: 20px auto;
            color: white;
        }

        .dictation-feedback {
            font-size: 20px;
            padding: 15px 30px;
            border-radius: 50px;
            margin: 20px 0;
            font-weight: bold;
        }

        .dictation-feedback.correct {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 2px solid #22c55e;
        }

        .dictation-feedback.wrong {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 2px solid #ef4444;
        }

        .word-list {
            max-height: 400px;
            overflow-y: auto;
            background: #0f172a;
            border-radius: 20px;
            padding: 10px;
        }

        .word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #334155;
        }

        .word-item:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none !important;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .badge {
            background: #334155;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
            margin-left: 8px;
        }

        .badge.mastered {
            background: #22c55e;
            color: #0f172a;
        }

        .badge.mistake {
            background: #ef4444;
        }

        .category-tag {
            background: #475569;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 8px;
        }

        .telegram-status {
            background: #0088cc20;
            border: 1px solid #0088cc;
            border-radius: 12px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .telegram-status.success {
            background: #22c55e20;
            border-color: #22c55e;
        }

        .telegram-status.error {
            background: #ef444420;
            border-color: #ef4444;
        }

        @media (max-width: 600px) {
            .flashcard-word {
                font-size: 40px;
            }
            .flashcard-meaning {
                font-size: 32px;
            }
            .btn-group button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö ADVANCED SPEAKING LABS</h1>

        <!-- Mr AbdulAziz's Quote -->
        <div class="quote-banner">
            "Either increase sacrifices or reduce dreams"
            <div class="quote-author">‚Äî Mr AbdulAziz</div>
        </div>

        <!-- Login -->
        <div class="card" id="login">
            <h2>Welcome!</h2>
            <input type="text" id="name" placeholder="Your full name">
            <input type="text" id="group" placeholder="Class/Group (e.g., 9A)">
            
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="enableVoice" checked>
                    Enable voice pronunciation
                </label>
            </div>
            
            <button onclick="startApp()">Start Learning</button>
            <p style="text-align: center; margin-top: 15px; font-size: 14px; color: #94a3b8;">
                ü§ñ Your progress will be sent to your teacher
            </p>
        </div>

        <!-- Dashboard -->
        <div class="card hidden" id="dashboard">
            <div class="flex-between">
                <h2 id="welcomeMessage"></h2>
                <div>
                    <button onclick="toggleVoice()" class="voice" id="voiceBtn">üîä ON</button>
                    <button onclick="showResetConfirm()" class="danger">Reset</button>
                </div>
            </div>

            <!-- Telegram Status -->
            <div id="telegramStatus" class="telegram-status hidden">
                <span>ü§ñ</span>
                <span id="telegramMessage"></span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalWords">0</h3>
                    <p>Total Words</p>
                </div>
                <div class="stat-card">
                    <h3 id="masteredWords">0</h3>
                    <p>Mastered</p>
                </div>
                <div class="stat-card">
                    <h3 id="wordMistakesCount">0</h3>
                    <p>Word Mistakes</p>
                </div>
                <div class="stat-card">
                    <h3 id="dictMistakesCount">0</h3>
                    <p>Dictation Mistakes</p>
                </div>
            </div>

            <div class="btn-group">
                <button onclick="showAddWord()">‚ûï Add Word</button>
                <button onclick="startFlashcards()" class="success">üÉè Flashcards</button>
                <button onclick="startDictation()" class="voice">üéß Dictation</button>
                <button onclick="showMistakeOptions()" class="warning">üîÅ Practice Mistakes</button>
                <button onclick="showWordList()">üìñ Word List</button>
                <button onclick="showHistory()">üìä History</button>
            </div>
        </div>

        <!-- Add Word -->
        <div class="card hidden" id="addWord">
            <h2>Add New Word</h2>
            <input type="text" id="word" placeholder="English word">
            <input type="text" id="meaning" placeholder="Uzbek meaning">
            
            <select id="category">
                <option value="general">General</option>
                <option value="technology">Technology</option>
                <option value="food">Food & Drink</option>
                <option value="travel">Travel</option>
                <option value="academic">Academic</option>
                <option value="business">Business</option>
            </select>
            
            <input type="text" id="example" placeholder="Example sentence (optional)">
            
            <div class="btn-group">
                <button onclick="addWord()">üíæ Save Word</button>
                <button onclick="showSection('dashboard')" class="secondary">‚Üê Dashboard</button>
            </div>
        </div>

        <!-- Word List -->
        <div class="card hidden" id="wordList">
            <h2>My Vocabulary</h2>
            <div class="word-list" id="wordsContainer"></div>
            <button onclick="showSection('dashboard')" class="secondary">‚Üê Back</button>
        </div>

        <!-- History -->
        <div class="card hidden" id="history">
            <h2>Practice History</h2>
            <div id="historyContainer" class="word-list"></div>
            <button onclick="showSection('dashboard')" class="secondary">‚Üê Back</button>
        </div>

        <!-- Mistake Options -->
        <div class="card hidden" id="mistakeOptions">
            <h2>üîÅ Practice Mistakes</h2>
            <p style="margin-bottom: 20px;">Choose what to practice:</p>
            
            <div class="btn-group" style="flex-direction: column;">
                <button onclick="startMistakePractice('words')" class="success" id="wordMistakeBtn">
                    üìù Word Mistakes (0)
                </button>
                <button onclick="startMistakePractice('dictation')" class="voice" id="dictMistakeBtn">
                    üéß Dictation Mistakes (0)
                </button>
                <button onclick="showSection('dashboard')" class="secondary">‚Üê Back</button>
            </div>
        </div>

        <!-- FLASHCARDS -->
        <div class="card hidden" id="flashcardSection">
            <h2>üÉè Flashcard Practice</h2>

            <div class="flashcard-container" onclick="flipFlashcard()">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-front">
                        <div class="flashcard-word" id="flashcardWord"></div>
                        <div class="flashcard-example" id="flashcardExample"></div>
                        <div class="flashcard-progress">üëÜ Click to flip</div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-meaning" id="flashcardMeaning"></div>
                        <div class="flashcard-progress" id="flashcardLevel"></div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button onclick="prevFlashcard()" class="secondary">‚Üê Previous</button>
                <button onclick="markFlashcardCorrect()" class="success">‚úì Correct</button>
                <button onclick="markFlashcardIncorrect()" class="warning">‚úó Incorrect</button>
                <button onclick="nextFlashcard()" class="secondary">Next ‚Üí</button>
            </div>

            <div class="flex-between" style="margin-top: 20px;">
                <span id="flashcardCounter"></span>
                <button onclick="endFlashcards()" class="secondary">Exit</button>
            </div>
        </div>

        <!-- Flashcard Results -->
        <div class="card hidden" id="flashcardResults">
            <h2>üìä Flashcard Results</h2>
            
            <div class="results-card">
                <div class="results-score" id="flashcardScore">0%</div>
                <div class="results-detail" id="flashcardCorrect">0 correct</div>
                <div class="results-detail" id="flashcardWrong">0 mistakes</div>
                <div class="results-detail" id="flashcardTotal">0 total words</div>
            </div>
            
            <div id="flashcardTelegramStatus" class="telegram-status hidden">
                <span>ü§ñ</span>
                <span>Results sent to your teacher!</span>
            </div>
            
            <div class="btn-group">
                <button onclick="restartFlashcards()" class="success">üîÑ Practice Again</button>
                <button onclick="showSection('dashboard')" class="secondary">üè† Dashboard</button>
            </div>
        </div>

        <!-- DICTATION -->
        <div class="card hidden" id="dictationSection">
            <h2>üéß Dictation Challenge</h2>
            <p class="dictation-hint">Listen and type what you hear</p>

            <div class="dictation-area">
                <div class="dictation-center">
                    <div class="big-voice-icon">üîä</div>
                    
                    <div class="btn-group" style="width: 100%;">
                        <button onclick="playDictationWord()" class="voice">üîä Play</button>
                        <button onclick="playDictationSpelling()" class="voice">üî§ Spell</button>
                        <button onclick="playDictationSlow()" class="voice">üê¢ Slow</button>
                    </div>

                    <input type="text" id="dictationAnswer" class="dictation-input" 
                           placeholder="Type here..." autocomplete="off">

                    <div class="btn-group" style="width: 100%;">
                        <button onclick="checkDictation()" class="success">‚úÖ Check</button>
                        <button onclick="nextDictation()" class="secondary">‚è≠Ô∏è Next</button>
                        <button onclick="skipDictation()" class="warning">‚è© Skip</button>
                    </div>

                    <div id="dictationFeedback" class="dictation-feedback hidden"></div>

                    <div class="flex-between" style="width: 100%; margin-top: 20px;">
                        <span id="dictationScore">Score: 0/0</span>
                        <span id="dictationProgress">Word 1/‚àû</span>
                    </div>
                </div>
            </div>

            <button onclick="endDictationEarly()" class="secondary">‚Üê End Session</button>
        </div>

        <!-- Dictation Results -->
        <div class="card hidden" id="dictationResults">
            <h2>üìä Dictation Results</h2>
            
            <div class="results-card">
                <div class="results-score" id="dictationScoreResult">0%</div>
                <div class="results-detail" id="dictationCorrectResult">0 correct</div>
                <div class="results-detail" id="dictationWrongResult">0 mistakes</div>
                <div class="results-detail" id="dictationTotalResult">0 total words</div>
            </div>
            
            <div id="dictationTelegramStatus" class="telegram-status hidden">
                <span>ü§ñ</span>
                <span>Results sent to your teacher!</span>
            </div>
            
            <div class="btn-group">
                <button onclick="restartDictation()" class="success">üîÑ Practice Again</button>
                <button onclick="showSection('dashboard')" class="secondary">üè† Dashboard</button>
            </div>
        </div>

        <!-- Reset Confirmation -->
        <div class="card hidden" id="resetModal">
            <h2>‚ö†Ô∏è Reset Everything?</h2>
            <p>All words and progress will be deleted.</p>
            <p style="color: #f59e0b; margin: 10px 0;">"Either increase sacrifices or reduce dreams"</p>
            <div class="btn-group">
                <button onclick="resetAllData()" class="danger">Yes, Reset</button>
                <button onclick="hideResetModal()" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== ‚úÖ FIXED TELEGRAM CONFIG ====================
        const TELEGRAM_BOT_TOKEN = '8358278097:AAE7zvXUZ6WE-OzNoBcdlMwS4WM4qV6iEtI';
        const TEACHER_CHAT_ID = '1907669079';  // ‚úÖ YOUR REAL CHAT ID!
        
        // ==================== DATA ====================
        let vocabulary = [];
        let wordMistakes = [];
        let dictationMistakes = [];
        let practiceHistory = [];
        let categories = ['general', 'technology', 'food', 'travel', 'academic', 'business'];
        
        // User info
        let userName = '';
        let userGroup = '';
        
        // Voice settings
        let voiceEnabled = true;
        let voiceSpeed = 0.9;
        let speechSynth = window.speechSynthesis;
        let englishVoice = null;

        // Flashcard variables
        let flashcardSession = [];
        let flashcardIndex = 0;
        let flashcardCorrect = 0;
        let flashcardWrong = 0;
        let flashcardTotal = 0;
        let flashcardMistakeDetails = [];

        // Dictation variables
        let dictationSession = [];
        let dictationIndex = 0;
        let dictationCorrect = 0;
        let dictationWrong = 0;
        let dictationTotal = 0;
        let currentDictationWord = null;
        let dictationMistakeDetails = [];

        // ==================== TELEGRAM FUNCTIONS ====================
        async function sendToTelegram(message, section = 'flashcard') {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: TEACHER_CHAT_ID,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                const result = await response.json();
                console.log('Telegram result:', result);
                
                if (result.ok) {
                    showTelegramStatus('success', '‚úÖ Results sent to your teacher!', section);
                } else {
                    showTelegramStatus('error', '‚ùå Failed to send results', section);
                }
                
                return result.ok;
            } catch (error) {
                console.error('Telegram error:', error);
                showTelegramStatus('error', '‚ùå Network error - results not sent', section);
                return false;
            }
        }

        function showTelegramStatus(type, message, section = 'flashcard') {
            const statusId = section === 'flashcard' ? 'flashcardTelegramStatus' : 'dictationTelegramStatus';
            const statusEl = document.getElementById(statusId);
            
            if (statusEl) {
                statusEl.className = `telegram-status ${type}`;
                statusEl.querySelector('span:last-child').textContent = message;
                statusEl.classList.remove('hidden');
                
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 5000);
            }
        }

        function formatFlashcardResults() {
            const date = new Date();
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const mistakeText = flashcardMistakeDetails.map(m => 
                `‚Ä¢ ${m.word}`
            ).join('\n');
            
            const correctWords = flashcardSession
                .filter(w => !flashcardMistakeDetails.some(m => m.id === w.id))
                .map(w => `‚Ä¢ ${w.word}`)
                .join('\n');
            
            return `
ü§ñ <b>ADVANCED SPEAKING LABS</b>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üë§ Student: ${userName}${userGroup ? ` (${userGroup})` : ''}
üìù Practice: Flashcards
üìä Score: ${flashcardCorrect}/${flashcardTotal} (${Math.round((flashcardCorrect/flashcardTotal)*100)}%)
‚è∞ Time: ${formattedDate}

‚úÖ <b>Correct Words (${flashcardCorrect}):</b>
${correctWords || '‚Ä¢ None'}

‚ùå <b>Mistakes (${flashcardWrong} words):</b>
${mistakeText || '‚Ä¢ None'}

üìà Keep up the great work!
            `;
        }

        function formatDictationResults() {
            const date = new Date();
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const mistakeText = dictationMistakeDetails.map(m => 
                `‚Ä¢ ${m.word} ‚Üí wrote "${m.userAnswer || 'skipped'}"`
            ).join('\n');
            
            const correctWords = dictationSession
                .filter(w => !dictationMistakeDetails.some(m => m.id === w.id))
                .map(w => `‚Ä¢ ${w.word}`)
                .join('\n');
            
            return `
ü§ñ <b>ADVANCED SPEAKING LABS</b>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üë§ Student: ${userName}${userGroup ? ` (${userGroup})` : ''}
üìù Practice: Dictation
üìä Score: ${dictationCorrect}/${dictationTotal} (${Math.round((dictationCorrect/dictationTotal)*100)}%)
‚è∞ Time: ${formattedDate}

‚úÖ <b>Correct Words (${dictationCorrect}):</b>
${correctWords || '‚Ä¢ None'}

‚ùå <b>Mistakes (${dictationWrong} words):</b>
${mistakeText || '‚Ä¢ None'}

üìà Keep practicing!
            `;
        }

        // ==================== VOICE ====================
        function initializeVoice() {
            if (!speechSynth) return;
            const loadVoices = () => {
                const voices = speechSynth.getVoices();
                englishVoice = voices.find(v => v.lang.includes('en')) || voices[0];
            };
            if (speechSynth.onvoiceschanged) speechSynth.onvoiceschanged = loadVoices;
            loadVoices();
        }

        function speakText(text) {
            if (!voiceEnabled || !speechSynth || !text) return;
            speechSynth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = englishVoice;
            utterance.rate = voiceSpeed;
            utterance.lang = 'en-US';
            speechSynth.speak(utterance);
        }

        function speakSpelling(text) {
            if (!text) return;
            const spelled = text.split('').join(' ');
            speakText(spelled);
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            document.getElementById('voiceBtn').textContent = voiceEnabled ? 'üîä ON' : 'üîá OFF';
        }

        // ==================== DATA MANAGEMENT ====================
        function loadData() {
            const saved = localStorage.getItem('vocabTrainer_data_v4');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    vocabulary = data.vocabulary || [];
                    wordMistakes = data.wordMistakes || [];
                    dictationMistakes = data.dictationMistakes || [];
                    practiceHistory = data.practiceHistory || [];
                    userName = data.userName || '';
                    userGroup = data.userGroup || '';
                } catch (e) {
                    console.log('Error loading data');
                }
            }
        }

        function saveData() {
            const data = { 
                vocabulary, 
                wordMistakes, 
                dictationMistakes, 
                practiceHistory, 
                userName, 
                userGroup 
            };
            localStorage.setItem('vocabTrainer_data_v4', JSON.stringify(data));
        }

        // ==================== APP START ====================
        function startApp() {
            userName = document.getElementById('name').value.trim() || 'Student';
            userGroup = document.getElementById('group').value.trim();
            voiceEnabled = document.getElementById('enableVoice').checked;

            document.getElementById('login').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('welcomeMessage').textContent = `Welcome, ${userName}!`;

            saveData();
            updateStats();
            initializeVoice();
            
            // Send welcome notification
            sendToTelegram(`üëã ${userName}${userGroup ? ' ('+userGroup+')' : ''} started using the app!`);
        }

        function updateStats() {
            document.getElementById('totalWords').textContent = vocabulary.length;
            document.getElementById('masteredWords').textContent = vocabulary.filter(w => w.level >= 4).length;
            document.getElementById('wordMistakesCount').textContent = wordMistakes.length;
            document.getElementById('dictMistakesCount').textContent = dictationMistakes.length;
            
            const wordBtn = document.getElementById('wordMistakeBtn');
            const dictBtn = document.getElementById('dictMistakeBtn');
            if (wordBtn) wordBtn.innerHTML = `üìù Word Mistakes (${wordMistakes.length})`;
            if (dictBtn) dictBtn.innerHTML = `üéß Dictation Mistakes (${dictationMistakes.length})`;
        }

        function showSection(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function showWordList() {
            displayWordList();
            showSection('wordList');
        }

        function showHistory() {
            displayHistory();
            showSection('history');
        }

        function showAddWord() {
            document.getElementById('word').value = '';
            document.getElementById('meaning').value = '';
            document.getElementById('example').value = '';
            document.getElementById('category').value = 'general';
            showSection('addWord');
            document.getElementById('word').focus();
        }

        // ==================== ADD WORD ====================
        function addWord() {
            const word = document.getElementById('word').value.trim();
            const meaning = document.getElementById('meaning').value.trim();

            if (!word || !meaning) {
                alert('Enter both word and meaning!');
                return;
            }

            vocabulary.push({
                id: Date.now() + Math.random(),
                word: word,
                meaning: meaning,
                category: document.getElementById('category').value,
                example: document.getElementById('example').value.trim() || '',
                level: 1,
                correctCount: 0,
                wrongCount: 0,
                lastPracticed: null
            });

            document.getElementById('word').value = '';
            document.getElementById('meaning').value = '';
            document.getElementById('example').value = '';

            saveData();
            updateStats();
            alert(`"${word}" added!`);
            document.getElementById('word').focus();
        }

        function displayWordList() {
            const container = document.getElementById('wordsContainer');
            container.innerHTML = '';
            
            if (vocabulary.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">No words yet.</p>';
                return;
            }

            vocabulary.forEach(word => {
                container.innerHTML += `
                    <div class="word-item">
                        <div>
                            <strong>${word.word}</strong> ‚Üí ${word.meaning}
                            <span class="category-tag">${word.category || 'general'}</span>
                            <br><small>Level ${word.level} | ‚úì${word.correctCount} | ‚úó${word.wrongCount}</small>
                        </div>
                        <button onclick="deleteWord(${word.id})" class="secondary" style="padding: 5px 10px;">üóëÔ∏è</button>
                    </div>
                `;
            });
        }

        function deleteWord(id) {
            if (confirm('Delete this word?')) {
                vocabulary = vocabulary.filter(w => w.id !== id);
                wordMistakes = wordMistakes.filter(m => m.id !== id);
                dictationMistakes = dictationMistakes.filter(m => m.id !== id);
                saveData();
                displayWordList();
                updateStats();
            }
        }

        function displayHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';
            
            if (practiceHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">No history yet.</p>';
                return;
            }

            practiceHistory.slice(0, 20).forEach(session => {
                container.innerHTML += `
                    <div class="word-item">
                        <div>
                            <strong>${new Date(session.date).toLocaleDateString()}</strong>
                            <br>${session.type}: ${session.correct}/${session.total} (${session.score}%)
                        </div>
                    </div>
                `;
            });
        }

        // ==================== MISTAKES PRACTICE ====================
        function showMistakeOptions() {
            if (wordMistakes.length === 0 && dictationMistakes.length === 0) {
                alert('No mistakes yet! Great job!');
                return;
            }
            updateStats();
            showSection('mistakeOptions');
        }

        function startMistakePractice(type) {
            if (type === 'words') {
                if (wordMistakes.length === 0) {
                    alert('No word mistakes!');
                    return;
                }
                flashcardSession = [...wordMistakes];
                flashcardIndex = 0;
                flashcardCorrect = 0;
                flashcardWrong = 0;
                flashcardTotal = flashcardSession.length;
                flashcardMistakeDetails = [];
                showFlashcard();
                showSection('flashcardSection');
            } else {
                if (dictationMistakes.length === 0) {
                    alert('No dictation mistakes!');
                    return;
                }
                dictationSession = [...dictationMistakes];
                dictationIndex = 0;
                dictationCorrect = 0;
                dictationWrong = 0;
                dictationTotal = dictationSession.length;
                dictationMistakeDetails = [];
                currentDictationWord = dictationSession[0];
                document.getElementById('dictationFeedback').classList.add('hidden');
                document.getElementById('dictationAnswer').value = '';
                updateDictationUI();
                showSection('dictationSection');
                setTimeout(() => playDictationWord(), 500);
            }
        }

        // ==================== FLASHCARDS ====================
        function startFlashcards() {
            if (vocabulary.length === 0) {
                alert('Add some words first!');
                return;
            }

            const shuffled = [...vocabulary].sort(() => Math.random() - 0.5);
            flashcardSession = shuffled.slice(0, Math.min(20, vocabulary.length));
            flashcardIndex = 0;
            flashcardCorrect = 0;
            flashcardWrong = 0;
            flashcardTotal = flashcardSession.length;
            flashcardMistakeDetails = [];

            showFlashcard();
            showSection('flashcardSection');
        }

        function showFlashcard() {
            if (flashcardIndex >= flashcardSession.length) {
                endFlashcards();
                return;
            }

            const word = flashcardSession[flashcardIndex];
            document.getElementById('flashcardWord').textContent = word.word;
            document.getElementById('flashcardMeaning').textContent = word.meaning;
            document.getElementById('flashcardExample').textContent = word.example || 'No example';
            document.getElementById('flashcardLevel').textContent = `Level: ${'‚òÖ'.repeat(word.level)}${'‚òÜ'.repeat(5-word.level)}`;
            document.getElementById('flashcardCounter').textContent = 
                `Card ${flashcardIndex + 1}/${flashcardSession.length} | ‚úì${flashcardCorrect} ‚úó${flashcardWrong}`;

            document.getElementById('flashcard').classList.remove('flipped');
        }

        function flipFlashcard() {
            document.getElementById('flashcard').classList.toggle('flipped');
        }

        function nextFlashcard() {
            if (flashcardIndex < flashcardSession.length - 1) {
                flashcardIndex++;
                showFlashcard();
            } else {
                endFlashcards();
            }
        }

        function prevFlashcard() {
            if (flashcardIndex > 0) {
                flashcardIndex--;
                showFlashcard();
            }
        }

        function markFlashcardCorrect() {
            const word = flashcardSession[flashcardIndex];
            const vocabWord = vocabulary.find(w => w.id === word.id);
            
            if (vocabWord) {
                vocabWord.correctCount++;
                vocabWord.level = Math.min(5, vocabWord.level + 1);
                vocabWord.lastPracticed = new Date().toISOString();
                
                flashcardCorrect++;
                
                wordMistakes = wordMistakes.filter(m => m.id !== word.id);
            }

            saveData();
            nextFlashcard();
        }

        function markFlashcardIncorrect() {
            const word = flashcardSession[flashcardIndex];
            const vocabWord = vocabulary.find(w => w.id === word.id);
            
            if (vocabWord) {
                const oldLevel = vocabWord.level;
                vocabWord.wrongCount++;
                vocabWord.level = Math.max(1, vocabWord.level - 1);
                vocabWord.lastPracticed = new Date().toISOString();
                
                flashcardWrong++;
                
                flashcardMistakeDetails.push({
                    id: word.id,
                    word: word.word,
                    oldLevel: oldLevel,
                    newLevel: vocabWord.level
                });
                
                if (!wordMistakes.some(m => m.id === word.id)) {
                    wordMistakes.push({...word});
                }
            }

            saveData();
            nextFlashcard();
        }

        async function endFlashcards() {
            const score = flashcardTotal > 0 ? Math.round((flashcardCorrect / flashcardTotal) * 100) : 0;
            
            document.getElementById('flashcardScore').textContent = score + '%';
            document.getElementById('flashcardCorrect').textContent = `${flashcardCorrect} correct`;
            document.getElementById('flashcardWrong').textContent = `${flashcardWrong} mistakes`;
            document.getElementById('flashcardTotal').textContent = `${flashcardTotal} total words`;
            
            if (flashcardTotal > 0) {
                practiceHistory.unshift({
                    date: new Date().toISOString(),
                    type: 'Flashcards',
                    correct: flashcardCorrect,
                    total: flashcardTotal,
                    score: score
                });
                
                practiceHistory = practiceHistory.slice(0, 50);
                saveData();
                updateStats();
                
                // Send to Telegram
                const message = formatFlashcardResults();
                await sendToTelegram(message, 'flashcard');
            }

            showSection('flashcardResults');
        }

        function restartFlashcards() {
            startFlashcards();
        }

        // ==================== DICTATION ====================
        function startDictation() {
            if (vocabulary.length === 0) {
                alert('Add some words first!');
                return;
            }

            const shuffled = [...vocabulary].sort(() => Math.random() - 0.5);
            dictationSession = shuffled.slice(0, Math.min(10, vocabulary.length));
            
            dictationIndex = 0;
            dictationCorrect = 0;
            dictationWrong = 0;
            dictationTotal = dictationSession.length;
            dictationMistakeDetails = [];
            currentDictationWord = dictationSession[0];

            document.getElementById('dictationFeedback').classList.add('hidden');
            document.getElementById('dictationAnswer').value = '';
            
            updateDictationUI();
            showSection('dictationSection');
            
            setTimeout(() => playDictationWord(), 500);
        }

        function updateDictationUI() {
            if (dictationSession.length === 0) return;
            
            currentDictationWord = dictationSession[dictationIndex];
            document.getElementById('dictationScore').textContent = 
                `Score: ${dictationCorrect}/${dictationTotal}`;
            document.getElementById('dictationProgress').textContent = 
                `Word ${dictationIndex + 1}/${dictationSession.length}`;
            document.getElementById('dictationAnswer').value = '';
            document.getElementById('dictationFeedback').classList.add('hidden');
        }

        function playDictationWord() {
            if (currentDictationWord) {
                speakText(currentDictationWord.word);
            }
        }

        function playDictationSpelling() {
            if (currentDictationWord) {
                speakSpelling(currentDictationWord.word);
            }
        }

        function playDictationSlow() {
            if (currentDictationWord) {
                const originalSpeed = voiceSpeed;
                voiceSpeed = 0.6;
                speakText(currentDictationWord.word);
                setTimeout(() => { voiceSpeed = originalSpeed; }, 2000);
            }
        }

        function checkDictation() {
            const userAnswer = document.getElementById('dictationAnswer').value.trim().toLowerCase();
            const correctWord = currentDictationWord.word.toLowerCase();
            
            const isCorrect = (userAnswer === correctWord);
            
            const feedback = document.getElementById('dictationFeedback');
            feedback.textContent = isCorrect ? 
                `‚úÖ Correct! "${currentDictationWord.word}"` : 
                `‚ùå Wrong. The word is "${currentDictationWord.word}"`;
            feedback.className = `dictation-feedback ${isCorrect ? 'correct' : 'wrong'}`;
            feedback.classList.remove('hidden');
            
            const vocabWord = vocabulary.find(w => w.id === currentDictationWord.id);
            if (vocabWord) {
                if (isCorrect) {
                    vocabWord.correctCount++;
                    dictationCorrect++;
                    dictationMistakes = dictationMistakes.filter(m => m.id !== currentDictationWord.id);
                } else {
                    vocabWord.wrongCount++;
                    dictationWrong++;
                    
                    dictationMistakeDetails.push({
                        id: currentDictationWord.id,
                        word: currentDictationWord.word,
                        userAnswer: userAnswer
                    });
                    
                    if (!dictationMistakes.some(m => m.id === currentDictationWord.id)) {
                        dictationMistakes.push({...currentDictationWord});
                    }
                }
            }
            
            document.getElementById('dictationScore').textContent = 
                `Score: ${dictationCorrect}/${dictationTotal}`;
            
            saveData();
            updateStats();
        }

        function nextDictation() {
            if (dictationIndex < dictationSession.length - 1) {
                dictationIndex++;
                currentDictationWord = dictationSession[dictationIndex];
                updateDictationUI();
                playDictationWord();
            } else {
                endDictation();
            }
        }

        function skipDictation() {
            const vocabWord = vocabulary.find(w => w.id === currentDictationWord.id);
            if (vocabWord) {
                vocabWord.wrongCount++;
                dictationWrong++;
                
                dictationMistakeDetails.push({
                    id: currentDictationWord.id,
                    word: currentDictationWord.word,
                    userAnswer: 'skipped'
                });
                
                if (!dictationMistakes.some(m => m.id === currentDictationWord.id)) {
                    dictationMistakes.push({...currentDictationWord});
                }
            }
            
            document.getElementById('dictationScore').textContent = 
                `Score: ${dictationCorrect}/${dictationTotal}`;
            
            saveData();
            updateStats();
            nextDictation();
        }

        function endDictationEarly() {
            if (confirm('End dictation session?')) {
                endDictation();
            }
        }

        async function endDictation() {
            const score = dictationTotal > 0 ? Math.round((dictationCorrect / dictationTotal) * 100) : 0;
            
            document.getElementById('dictationScoreResult').textContent = score + '%';
            document.getElementById('dictationCorrectResult').textContent = `${dictationCorrect} correct`;
            document.getElementById('dictationWrongResult').textContent = `${dictationWrong} mistakes`;
            document.getElementById('dictationTotalResult').textContent = `${dictationTotal} total words`;
            
            if (dictationTotal > 0) {
                practiceHistory.unshift({
                    date: new Date().toISOString(),
                    type: 'Dictation',
                    correct: dictationCorrect,
                    total: dictationTotal,
                    score: score
                });
                
                practiceHistory = practiceHistory.slice(0, 50);
                saveData();
                updateStats();
                
                // Send to Telegram
                const message = formatDictationResults();
                await sendToTelegram(message, 'dictation');
            }
            
            showSection('dictationResults');
        }

        function restartDictation() {
            startDictation();
        }

        // ==================== RESET ====================
        function showResetConfirm() {
            document.getElementById('resetModal').classList.remove('hidden');
        }

        function hideResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
        }

        function resetAllData() {
            vocabulary = [];
            wordMistakes = [];
            dictationMistakes = [];
            practiceHistory = [];
            saveData();
            hideResetModal();
            updateStats();
            alert('All data cleared!');
        }

        // ==================== INIT ====================
        window.onload = function() {
            loadData();
            initializeVoice();
            
            if (userName) {
                document.getElementById('login').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('welcomeMessage').textContent = `Welcome back, ${userName}!`;
                updateStats();
            }
        };
    </script>
</body>
</html>
